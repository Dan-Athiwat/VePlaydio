<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TikTok Clone - Real Firebase</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-storage-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        /* CSS Reset & Structure */
        :root {
            --bg-color: #000;
            --text-color: #fff;
            --accent-color: #fe2c55;
            --nav-height: 60px;
        }
        body { margin: 0; padding: 0; background: var(--bg-color); color: var(--text-color); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; height: 100vh; }
        
        /* Screens */
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        .active { display: block; }

        /* Login Screen */
        #login-screen { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; background: linear-gradient(45deg, #111, #333); }
        .login-btn { padding: 15px 30px; background: white; color: black; border: none; border-radius: 5px; font-size: 18px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px; }

        /* Main App Layout */
        #app-screen { display: none; flex-direction: column; height: 100vh; }
        
        /* Top Navigation (Floating) */
        .top-nav { position: absolute; top: 0; width: 100%; z-index: 100; padding: 15px 0; background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent); display: flex; justify-content: center; align-items: center; gap: 20px; font-weight: bold; font-size: 16px; pointer-events: none; }
        .top-nav span { color: rgba(255,255,255,0.6); pointer-events: auto; cursor: pointer; }
        .top-nav span.active-tab { color: white; border-bottom: 2px solid white; padding-bottom: 3px; }
        .search-btn { position: absolute; right: 20px; pointer-events: auto; cursor: pointer; font-size: 20px; }

        /* Video Feed (Scroll Snap) */
        .video-feed { height: calc(100vh - var(--nav-height)); overflow-y: scroll; scroll-snap-type: y mandatory; scroll-behavior: smooth; }
        .video-container { width: 100%; height: 100%; position: relative; scroll-snap-align: start; background: #111; display: flex; justify-content: center; align-items: center; }
        video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Video Overlay Controls */
        .video-sidebar { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 10; }
        .sidebar-icon { display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; text-shadow: 1px 1px 2px rgba(0,0,0,0.5); }
        .sidebar-icon i { font-size: 30px; }
        .profile-pic-feed { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
        .like-active { color: var(--accent-color); }
        
        .video-info { position: absolute; bottom: 80px; left: 10px; width: 70%; z-index: 10; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); pointer-events: none; }
        .video-info h3, .video-info p { margin: 5px 0; pointer-events: auto; }
        .music-disc { position: absolute; bottom: 20px; right: 10px; width: 40px; height: 40px; border-radius: 50%; background: #222; border: 5px solid #111; animation: spin 4s linear infinite; }
        
        /* Bottom Navigation */
        .bottom-nav { height: var(--nav-height); background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; z-index: 200; position: fixed; bottom: 0; width: 100%; }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #777; cursor: pointer; }
        .nav-item.active { color: white; }
        .nav-item i { font-size: 22px; margin-bottom: 3px; }
        .create-btn { width: 45px; height: 30px; background: linear-gradient(to right, #0ff, #f0f); border-radius: 8px; display: flex; justify-content: center; align-items: center; }
        .create-btn i { color: black; font-size: 16px; margin: 0; }

        /* Profile Page */
        #profile-view { padding: 60px 0 60px 0; overflow-y: auto; height: 100vh; box-sizing: border-box; }
        .profile-header { text-align: center; padding: 20px; }
        .profile-img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; }
        .stats-bar { display: flex; justify-content: center; gap: 30px; margin: 20px 0; }
        .stat-box { text-align: center; }
        .action-buttons { display: flex; justify-content: center; gap: 10px; }
        .btn-edit { padding: 8px 20px; border: 1px solid #ccc; background: transparent; color: white; border-radius: 4px; }
        .video-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; }
        .grid-item { aspect-ratio: 9/16; background: #222; position: relative; cursor: pointer; }
        
        /* Upload & Search Overlay */
        .overlay-screen { background: #000; z-index: 300; padding: 20px; display: none; }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; }
        input[type="text"], textarea { width: 100%; background: #222; border: none; padding: 15px; color: white; margin-bottom: 10px; border-radius: 5px; }
        .upload-area { border: 2px dashed #444; padding: 40px; text-align: center; margin-bottom: 20px; cursor: pointer; }

        /* Utilities */
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1>TikTok Clone</h1>
        <button class="login-btn" onclick="signInWithGoogle()">
            <i class="fab fa-google"></i> ลงชื่อเข้าใช้ด้วย Google
        </button>
    </div>

    <div id="app-screen" class="screen">
        
        <div class="top-nav" id="feed-header">
            <span>กำลังติดตาม</span>
            <span class="active-tab">สำหรับคุณ</span>
            <div class="search-btn" onclick="openSearch()"><i class="fas fa-search"></i></div>
        </div>

        <div id="main-content" style="height: 100%;">
            
            <div id="feed-view" class="video-feed">
                </div>

            <div id="profile-view" class="hidden">
                <div class="top-nav" style="position: sticky; background: #000; justify-content: space-between; padding: 10px 20px;">
                    <span id="profile-username">User</span>
                    <i class="fas fa-bars" onclick="toggleSettings()"></i>
                </div>
                <div class="profile-header">
                    <img id="profile-pic" src="" class="profile-img">
                    <h2 id="profile-display-name">...</h2>
                    <div class="stats-bar">
                        <div class="stat-box"><b>0</b><br><small>กำลังติดตาม</small></div>
                        <div class="stat-box"><b>0</b><br><small>ผู้ติดตาม</small></div>
                        <div class="stat-box"><b>0</b><br><small>ถูกใจ</small></div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn-edit" id="btn-edit-profile" onclick="editProfile()">แก้ไขโปรไฟล์</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-around; border-bottom: 1px solid #222; padding: 10px 0;">
                    <i class="fas fa-th"></i>
                    <i class="fas fa-heart"></i>
                    <i class="fas fa-lock"></i>
                </div>
                <div class="video-grid" id="profile-grid">
                    </div>
            </div>

        </div>

        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')"><i class="fas fa-home"></i><span>หน้าหลัก</span></div>
            <div class="nav-item"><i class="fas fa-user-friends"></i><span>เพื่อน</span></div>
            <div class="create-btn" onclick="openUpload()"><i class="fas fa-plus"></i></div>
            <div class="nav-item"><i class="fas fa-inbox"></i><span>กล่องขาเข้า</span></div>
            <div class="nav-item" onclick="switchTab('profile')"><i class="fas fa-user"></i><span>โปรไฟล์</span></div>
        </div>
    </div>

    <div id="upload-screen" class="screen overlay-screen">
        <div class="overlay-header">
            <i class="fas fa-times" onclick="closeOverlay()"></i>
            <h3>โพสต์</h3>
        </div>
        <div class="upload-area" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-cloud-upload-alt" style="font-size: 40px; margin-bottom: 10px;"></i>
            <p>เลือกคลิป (ไม่เกิน 10 นาที)</p>
        </div>
        <input type="file" id="file-input" accept="video/*" hidden onchange="handleFileSelect(this)">
        <input type="text" id="upload-caption" placeholder="อธิบายคลิปของคุณ...">
        <div id="sound-selector" style="background:#222; padding:10px; margin-bottom:10px; border-radius:5px;">
            <i class="fas fa-music"></i> เสียง: <span id="selected-sound">เสียงยอดนิยม (สุ่ม)</span>
        </div>
        <button class="login-btn" style="width:100%; background: var(--accent-color); color: white;" onclick="uploadVideo()">โพสต์</button>
    </div>

    <div id="search-screen" class="screen overlay-screen">
        <div class="overlay-header">
            <i class="fas fa-arrow-left" onclick="closeOverlay()"></i>
            <input type="text" id="search-input" placeholder="ค้นหา..." style="margin:0; width: 80%;">
            <span onclick="performSearch()">ค้นหา</span>
        </div>
        <div id="search-results" class="video-grid"></div>
    </div>

    <script>
        // ==========================================
        //  CONFIG: ใส่ Firebase Keys ของคุณที่นี่
        // ==========================================
        const firebaseConfig = {
  apiKey: "AIzaSyB575txzpvEoiUPGAzMWmBIJ-AumUrPZ04",
  authDomain: "mychatapp-6553a.firebaseapp.com",
  databaseURL: "https://mychatapp-6553a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mychatapp-6553a",
  storageBucket: "mychatapp-6553a.firebasestorage.app",
  messagingSenderId: "327022378740",
  appId: "1:327022378740:web:381b0688ed36b48a90e8a1",
  measurementId: "G-X4LL87Q0Z4"
};

        // Initialize Firebase
        // (ใช้ try-catch เพื่อป้องกันหน้าขาวถ้ายังไม่ได้ใส่ Key)
        let auth, db, storage;
        try {
            firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            storage = firebase.storage();
        } catch (e) {
            console.error("Firebase Init Error: กรุณาใส่ API Key");
            alert("กรุณาใส่ Firebase Config ในโค้ดก่อนใช้งาน!");
        }

        // Global State
        let currentUser = null;
        let videos = []; 
        let currentFile = null;

        // ==========================================
        //  AUTHENTICATION
        // ==========================================
        function signInWithGoogle() {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Login Success
                    checkUserSetup(result.user);
                }).catch((error) => {
                    alert("Login Error: " + error.message);
                });
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('login-screen').classList.remove('active');
                document.getElementById('app-screen').style.display = 'flex';
                loadFeed();
                loadProfile();
            } else {
                document.getElementById('login-screen').classList.add('active');
                document.getElementById('app-screen').style.display = 'none';
            }
        });

        async function checkUserSetup(user) {
            const userRef = db.collection('users').doc(user.uid);
            const doc = await userRef.get();
            if (!doc.exists) {
                // สร้าง User ใหม่ใน DB
                await userRef.set({
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    followers: 0,
                    following: 0,
                    totalLikes: 0,
                    searchKeywords: generateKeywords(user.displayName),
                    lastUsernameChange: 0
                });
            }
        }

        // ==========================================
        //  NAVIGATION & UI
        // ==========================================
        function switchTab(tab) {
            const feedView = document.getElementById('feed-view');
            const profileView = document.getElementById('profile-view');
            const navItems = document.querySelectorAll('.nav-item');
            
            navItems.forEach(i => i.classList.remove('active'));

            if (tab === 'home') {
                feedView.classList.remove('hidden');
                profileView.classList.add('hidden');
                document.getElementById('feed-header').classList.remove('hidden');
                navItems[0].classList.add('active');
            } else if (tab === 'profile') {
                feedView.classList.add('hidden');
                profileView.classList.remove('hidden');
                document.getElementById('feed-header').classList.add('hidden');
                navItems[4].classList.add('active');
                loadProfile(); // Reload data
            }
        }

        function closeOverlay() {
            document.querySelectorAll('.overlay-screen').forEach(el => el.style.display = 'none');
            document.getElementById('app-screen').classList.add('active');
        }

        // ==========================================
        //  FEED & VIDEO LOGIC
        // ==========================================
        function loadFeed() {
            const feedContainer = document.getElementById('feed-view');
            feedContainer.innerHTML = ''; // Clear

            // Query คลิปยอดนิยม (จำลอง: ดึงล่าสุด)
            db.collection('videos').orderBy('timestamp', 'desc').limit(10).get().then(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const videoEl = createVideoElement(doc.id, data);
                    feedContainer.appendChild(videoEl);
                });
            });
        }

        function createVideoElement(vidId, data) {
            const div = document.createElement('div');
            div.className = 'video-container';
            
            // Format Date
            const date = data.timestamp ? new Date(data.timestamp.seconds * 1000).toLocaleDateString('th-TH') : '';

            div.innerHTML = `
                <video src="${data.url}" loop onclick="togglePlay(this)"></video>
                
                <div class="video-info">
                    <h3>@${data.uploaderName}</h3>
                    <p>${data.caption}</p>
                    <p style="font-size:12px; opacity:0.7;"><i class="fas fa-music"></i> ${data.soundName} • ${date}</p>
                </div>

                <div class="video-sidebar">
                    <div class="sidebar-icon" onclick="viewProfile('${data.uploaderId}')">
                        <img src="${data.uploaderPhoto}" class="profile-pic-feed">
                        <i class="fas fa-plus-circle" style="color:red; margin-top:-15px; background:white; border-radius:50%;"></i>
                    </div>
                    <div class="sidebar-icon" onclick="likeVideo('${vidId}', this)">
                        <i class="fas fa-heart"></i>
                        <span>${data.likes || 0}</span>
                    </div>
                    <div class="sidebar-icon">
                        <i class="fas fa-comment-dots"></i>
                        <span>${data.comments || 0}</span>
                    </div>
                    <div class="sidebar-icon">
                        <i class="fas fa-bookmark"></i>
                        <span>Save</span>
                    </div>
                    <div class="sidebar-icon">
                        <i class="fas fa-share"></i>
                        <span>Share</span>
                    </div>
                     <div class="sidebar-icon" onclick="useSound('${data.soundName}')">
                        <div class="music-disc"></div>
                    </div>
                </div>
            `;
            
            // Auto Play logic for intersection observer could be added here
            return div;
        }

        function togglePlay(video) {
            if (video.paused) video.play();
            else video.pause();
        }

        function likeVideo(vidId, btn) {
            const icon = btn.querySelector('i');
            const countSpan = btn.querySelector('span');
            
            if (icon.classList.contains('like-active')) {
                // Unlike logic
                icon.classList.remove('like-active');
                // Real implementation: Firestore increment(-1)
            } else {
                // Like logic
                icon.classList.add('like-active');
                // Real implementation: Firestore increment(1) & Add to 'liked_videos' collection
            }
        }

        // ==========================================
        //  UPLOAD LOGIC
        // ==========================================
        function openUpload() {
            document.getElementById('upload-screen').style.display = 'block';
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (file) {
                // Check duration logic would require loading video metadata
                // For now, check size (approx 100MB max)
                if (file.size > 100 * 1024 * 1024) {
                    alert("ไฟล์ใหญ่เกินไป");
                    return;
                }
                currentFile = file;
                alert("เลือกไฟล์สำเร็จ: " + file.name);
            }
        }

        function uploadVideo() {
            if (!currentFile) return alert("กรุณาเลือกไฟล์");
            
            const caption = document.getElementById('upload-caption').value;
            const soundName = "เสียงยอดนิยม - Original";
            
            // 1. Upload File to Firebase Storage
            const storageRef = storage.ref(`videos/${currentUser.uid}/${Date.now()}_${currentFile.name}`);
            const uploadTask = storageRef.put(currentFile);

            uploadTask.on('state_changed', 
                (snapshot) => {
                    // Progress...
                    console.log((snapshot.bytesTransferred / snapshot.totalBytes) * 100 + '%');
                }, 
                (error) => {
                    alert("Upload Failed: " + error.message);
                }, 
                () => {
                    // Complete
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        // 2. Save Metadata to Firestore
                        db.collection('videos').add({
                            uploaderId: currentUser.uid,
                            uploaderName: currentUser.displayName,
                            uploaderPhoto: currentUser.photoURL,
                            caption: caption,
                            url: downloadURL,
                            soundName: soundName,
                            likes: 0,
                            comments: 0,
                            shares: 0,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                            searchKeywords: generateKeywords(caption)
                        }).then(() => {
                            alert("อัพโหลดเสร็จสิ้น!");
                            closeOverlay();
                            loadFeed(); // Refresh feed
                        });
                    });
                }
            );
        }

        // ==========================================
        //  SEARCH
        // ==========================================
        function openSearch() {
            document.getElementById('search-screen').style.display = 'block';
        }

        function performSearch() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const resultsDiv = document.getElementById('search-results');
            resultsDiv.innerHTML = 'กำลังค้นหา...';

            // Simple client-side filtering for demo (Firestore search is complex)
            db.collection('videos').get().then(snapshot => {
                resultsDiv.innerHTML = '';
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.caption.toLowerCase().includes(query)) {
                        const div = document.createElement('div');
                        div.className = 'grid-item';
                        div.innerHTML = `<video src="${data.url}" style="width:100%; height:100%; object-fit:cover;"></video>`;
                        div.onclick = () => { /* Open video detail */ };
                        resultsDiv.appendChild(div);
                    }
                });
            });
        }

        function generateKeywords(str) {
            // Helper for search array
            return str ? str.toLowerCase().split(' ') : [];
        }

        // ==========================================
        //  PROFILE LOGIC
        // ==========================================
        function loadProfile() {
            if (!currentUser) return;
            document.getElementById('profile-username').innerText = currentUser.displayName;
            document.getElementById('profile-display-name').innerText = "@" + currentUser.uid.substring(0,8); // Simulate username
            document.getElementById('profile-pic').src = currentUser.photoURL;

            // Load User Videos
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = '';
            
            db.collection('videos').where('uploaderId', '==', currentUser.uid).get().then(snapshot => {
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const div = document.createElement('div');
                    div.className = 'grid-item';
                    div.innerHTML = `<video src="${data.url}#t=0.1" preload="metadata" style="width:100%; height:100%; object-fit:cover;"></video>`;
                    grid.appendChild(div);
                });
            });
        }

        function editProfile() {
            // Check 7 days logic here using 'lastUsernameChange'
            const newName = prompt("ใส่ชื่อใหม่ (เปลี่ยนได้ทุก 7 วัน):", currentUser.displayName);
            if (newName) {
                currentUser.updateProfile({ displayName: newName }).then(() => {
                    loadProfile();
                });
            }
        }

        function useSound(soundName) {
            // Logic to use this sound
            alert("กำลังใช้เสียง: " + soundName);
            openUpload();
            document.getElementById('selected-sound').innerText = soundName;
        }

    </script>
</body>
</html>