<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NextGen iOS Fix (V4.3)</title>
    <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.18.2.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        /* --- THEME --- */
        :root {
            --primary: #007AFF; --bg: #121212; --surface: #1e1e1e;
            --text: #ffffff; --danger: #ff3b30; --success: #34c759;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Kanit', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body {
            background-color: var(--bg); color: var(--text);
            height: 100vh; width: 100vw; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- COMPONENTS --- */
        .btn {
            border: none; border-radius: 12px; padding: 12px 20px; cursor: pointer;
            font-size: 1rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s; width: 100%; color: white;
        }
        .btn:active { transform: scale(0.96); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); }
        .btn-outline { background: transparent; border: 1px solid #444; width: auto; }

        input {
            width: 100%; padding: 14px; background: #2c2c2e; border: 1px solid #3a3a3c;
            border-radius: 10px; color: white; outline: none; margin-bottom: 15px; font-size: 1rem;
        }

        /* --- SCREENS --- */
        .screen { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 10; background: var(--bg); }
        .screen.active { display: flex; }

        /* Auth Screen */
        .auth-container {
            justify-content: center; align-items: center;
            background: radial-gradient(circle, #2a2a2a 0%, #000000 100%); padding: 20px;
        }
        .auth-box {
            width: 100%; max-width: 400px; background: rgba(30, 30, 30, 0.95);
            padding: 40px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        .switch-btn {
            background: none; border: none; color: var(--primary); margin-top: 20px;
            cursor: pointer; text-decoration: underline; font-size: 0.9rem;
        }

        /* --- DASHBOARD --- */
        #dashboard-screen { flex-direction: row; }
        .sidebar {
            width: 320px; background: var(--surface); border-right: 1px solid #333;
            display: flex; flex-direction: column; padding: 20px; overflow-y: auto; z-index: 20;
        }
        .mobile-header { display: none; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .profile-card { text-align: center; margin-bottom: 30px; padding-bottom: 20px; border-bottom: 1px solid #333; }
        .avatar-frame {
            width: 100px; height: 100px; margin: 0 auto 15px; border-radius: 50%;
            border: 3px solid var(--primary); overflow: hidden; position: relative;
        }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .edit-badge {
            position: absolute; bottom: 0; width: 100%; background: rgba(0,0,0,0.7);
            color: white; font-size: 10px; padding: 4px; cursor: pointer;
        }

        .room-card {
            background: #2a2a2a; padding: 15px; border-radius: 10px; margin-bottom: 10px;
            display: flex; justify-content: space-between; align-items: center;
        }

        .main-content {
            flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: var(--bg); position: relative;
        }
        .mobile-back-btn { display: none; position: absolute; top: 20px; left: 20px; color: white; font-size: 1.5rem; cursor: pointer; }
        .join-box { text-align: center; width: 90%; max-width: 350px; }
        .join-input-group { display: flex; gap: 10px; }

        /* --- VIDEO ROOM --- */
        #video-screen { background: black; flex-direction: column; }
        .video-grid {
            flex: 1; width: 100%; height: 100%; display: grid; gap: 8px; padding: 10px; padding-bottom: 100px;
            align-content: center; justify-content: center;
        }

        .video-item {
            background: #222; border-radius: 12px; overflow: hidden; position: relative;
            width: 100%; height: 100%; min-height: 200px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .video-player { width: 100%; height: 100%; object-fit: cover; }
        .video-player.screen-share { object-fit: contain; background: #111; } 
        
        .name-label {
            position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.6);
            color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.8rem;
        }

        /* Controls */
        .controls {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; background: rgba(40,40,40,0.95);
            padding: 12px 25px; border-radius: 50px; backdrop-filter: blur(10px); z-index: 100;
            width: 90%; max-width: 500px; justify-content: space-around;
        }
        .ctrl-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none; background: #3a3a3c;
            color: white; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
        }
        .ctrl-btn.active { background: white; color: black; }
        .ctrl-btn.off { background: rgba(255,255,255,0.1); color: var(--danger); }
        .ctrl-btn.hangup { background: var(--danger); color: white; width: 60px; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            #dashboard-screen { flex-direction: column; }
            .sidebar { width: 100%; height: 100%; border: none; padding: 20px; display: flex; }
            
            .main-content { 
                position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                background: var(--bg); z-index: 30; transform: translateX(100%); transition: transform 0.3s ease;
            }
            .main-content.show-mobile { transform: translateX(0); }
            
            .mobile-header { display: flex; }
            .mobile-back-btn { display: block; }
            .join-input-group { flex-direction: column; }

            .video-grid { 
                display: flex; flex-direction: column; overflow-y: auto; justify-content: flex-start;
            }
            .video-item { flex-shrink: 0; height: 250px; margin-bottom: 10px; }
        }
        
        @media (min-width: 769px) {
            .grid-1 { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: 1fr 1fr; }
            .grid-3 { grid-template-columns: repeat(3, 1fr); }
            .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; }
            .grid-5, .grid-6 { grid-template-columns: repeat(3, 1fr); grid-template-rows: 1fr 1fr; }
        }
    </style>
</head>
<body>

    <div id="login-ui" class="screen auth-container">
        <div class="auth-box">
            <h2 style="margin-bottom:20px;">เข้าสู่ระบบ</h2>
            <input type="text" id="l-name" placeholder="ชื่อผู้ใช้">
            <input type="tel" id="l-phone" placeholder="เบอร์โทรศัพท์">
            <button class="btn btn-primary" onclick="doLogin()">เข้าสู่ระบบ</button>
            <button class="switch-btn" type="button" onclick="goToRegister()">ยังไม่มีบัญชี? สร้างผู้ใช้ใหม่</button>
        </div>
    </div>

    <div id="register-ui" class="screen auth-container">
        <div class="auth-box">
            <h2 style="margin-bottom:20px;">สร้างผู้ใช้ใหม่</h2>
            <input type="text" id="r-name" placeholder="ชื่อ (ห้ามซ้ำ)">
            <input type="tel" id="r-phone" placeholder="เบอร์โทรศัพท์">
            <button class="btn btn-primary" onclick="doRegister()">ยืนยันการสมัคร</button>
            <button class="switch-btn" type="button" onclick="goToLogin()">มีบัญชีแล้ว? เข้าสู่ระบบ</button>
        </div>
    </div>

    <div id="dashboard-screen" class="screen">
        <div class="sidebar">
            <div class="mobile-header">
                <h3>โปรไฟล์ของคุณ</h3>
                <button class="btn btn-primary" style="width:auto; padding: 8px 12px;" onclick="toggleMobileJoin(true)">
                    <i class="fas fa-search"></i>
                </button>
            </div>

            <div class="profile-card">
                <div class="avatar-frame">
                    <img id="user-pic" src="https://via.placeholder.com/100" class="avatar-img">
                    <label for="up-pic" class="edit-badge">แก้ไข</label>
                    <input type="file" id="up-pic" hidden accept="image/*" onchange="updatePic(this)">
                </div>
                <h3 id="user-name">Loading...</h3>
                <p id="user-phone" style="color:#aaa; font-size:0.9rem;">...</p>
                <div style="margin-top:10px; display:flex; gap:10px; justify-content:center;">
                    <button class="btn btn-outline" style="font-size:0.8rem; padding:5px 10px;" onclick="editName()"><i class="fas fa-pen"></i> แก้ชื่อ</button>
                    <button class="btn btn-danger" style="width:auto; font-size:0.8rem; padding:5px 10px;" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
                </div>
            </div>

            <h4 style="margin-bottom:10px; color:#aaa;">จัดการห้อง</h4>
            <button class="btn btn-primary" style="margin-bottom:20px;" onclick="createRoom()">
                <i class="fas fa-plus"></i> สร้างห้องใหม่
            </button>

            <h4 style="margin-bottom:10px; color:#aaa;">ประวัติห้องของคุณ</h4>
            <div id="room-list" class="room-history"></div>
        </div>

        <div id="main-content" class="main-content">
            <div class="mobile-back-btn" onclick="toggleMobileJoin(false)"><i class="fas fa-arrow-left"></i></div>
            <div class="join-box">
                <i class="fas fa-broadcast-tower" style="font-size:4rem; color:#444; margin-bottom:20px;"></i>
                <h2>เข้าร่วมการสนทนา</h2>
                <div class="join-input-group">
                    <input type="text" id="join-id" placeholder="กรอก Room ID" style="margin-bottom:0;">
                    <button class="btn btn-primary" style="width: auto; min-width: 80px;" onclick="joinRoomFromInput()">เข้าร่วม</button>
                </div>
            </div>
        </div>
    </div>

    <div id="video-screen" class="screen">
        <div style="position:absolute; top:15px; left:20px; z-index:50; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px;">
            <i class="fas fa-hashtag" style="color:var(--primary)"></i> <span id="room-display">ID: --</span>
        </div>
        <div id="video-grid" class="video-grid grid-1"></div>
        <div class="controls">
            <button class="ctrl-btn active" id="btn-mic" onclick="toggleMic()"><i class="fas fa-microphone"></i></button>
            <button class="ctrl-btn active" id="btn-cam" onclick="toggleCam()"><i class="fas fa-video"></i></button>
            <button class="ctrl-btn active" id="btn-vol" onclick="toggleSpeaker()"><i class="fas fa-volume-up"></i></button>
            <button class="ctrl-btn off" id="btn-screen" onclick="toggleShare()"><i class="fas fa-desktop"></i></button>
            <button class="ctrl-btn hangup" onclick="leaveRoom()"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <script>
        // ==========================================
        // ⚙️ CONFIGURATION (ใส่ APP ID ตรงนี้)
        // ==========================================
        const AGORA_APP_ID = "ebab3ce9350a43c4bf6fb4312a3dbd23"; 

        // State
        let currentUser = null;
        // ⚠️ iOS Fix: เปลี่ยน Codec เป็น H.264 เพื่อป้องกันการเด้ง
        let client = AgoraRTC.createClient({ mode: "rtc", codec: "h264" });
        
        let localTracks = { audio: null, video: null, screen: null };
        let remoteUsers = {};
        let isScreenSharing = false;
        let isSpeakerOn = true;

        // --- INIT ---
        window.onload = () => {
            if(location.protocol !== 'https:' && location.hostname !== 'localhost') {
                alert("⚠️ iOS ต้องรันบน HTTPS เท่านั้น ไม่อย่างนั้นจะเด้งออก");
            }
            const saved = localStorage.getItem('currUser');
            if(saved) {
                currentUser = JSON.parse(saved);
                showScreen('dashboard');
                renderProfile();
            } else {
                showScreen('login');
            }
        };

        // --- NAVIGATION & AUTH ---
        function showScreen(name) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            if(name === 'login') document.getElementById('login-ui').classList.add('active');
            else if(name === 'register') document.getElementById('register-ui').classList.add('active');
            else if(name === 'dashboard') document.getElementById('dashboard-screen').classList.add('active');
            else if(name === 'video') document.getElementById('video-screen').classList.add('active');
        }
        function goToRegister() { showScreen('register'); }
        function goToLogin() { showScreen('login'); }
        function toggleMobileJoin(show) {
            const main = document.getElementById('main-content');
            if(show) main.classList.add('show-mobile'); else main.classList.remove('show-mobile');
        }

        function doRegister() {
            const name = document.getElementById('r-name').value.trim();
            const phone = document.getElementById('r-phone').value.trim();
            if(!name || !phone) return alert("กรอกข้อมูลให้ครบ");
            let db = JSON.parse(localStorage.getItem('userDB') || "[]");
            if(db.find(u => u.name === name)) return alert("ชื่อนี้ซ้ำ");
            db.push({ name, phone, pic: null }); localStorage.setItem('userDB', JSON.stringify(db));
            alert("สมัครสำเร็จ!"); goToLogin();
        }
        function doLogin() {
            const name = document.getElementById('l-name').value.trim();
            const phone = document.getElementById('l-phone').value.trim();
            let db = JSON.parse(localStorage.getItem('userDB') || "[]");
            const user = db.find(u => u.name === name && u.phone === phone);
            if(user) { currentUser = user; localStorage.setItem('currUser', JSON.stringify(user)); showScreen('dashboard'); renderProfile(); }
            else { alert("ข้อมูลไม่ถูกต้อง"); }
        }
        function logout() { localStorage.removeItem('currUser'); location.reload(); }

        // --- PROFILE ---
        function renderProfile() {
            document.getElementById('user-name').innerText = currentUser.name;
            document.getElementById('user-phone').innerText = currentUser.phone;
            if(currentUser.pic) document.getElementById('user-pic').src = currentUser.pic;
            const list = document.getElementById('room-list'); list.innerHTML = '';
            let myRooms = JSON.parse(localStorage.getItem('myRooms') || "[]");
            myRooms.forEach(r => {
                list.innerHTML += `<div class="room-card">
                    <div><div style="color:var(--primary); font-weight:bold;">ID: ${r.id}</div><small>${r.date}</small></div>
                    <button class="btn btn-primary" style="width:auto; font-size:0.8rem; padding:5px 15px;" onclick="joinRoom('${r.id}')">Join</button>
                </div>`;
            });
        }
        function updatePic(input) {
            if(input.files[0]) {
                const r = new FileReader();
                r.onload = (e) => {
                    currentUser.pic = e.target.result; localStorage.setItem('currUser', JSON.stringify(currentUser));
                    let db = JSON.parse(localStorage.getItem('userDB'));
                    const i = db.findIndex(u => u.name === currentUser.name);
                    if(i > -1) { db[i] = currentUser; localStorage.setItem('userDB', JSON.stringify(db)); }
                    renderProfile();
                }; r.readAsDataURL(input.files[0]);
            }
        }
        function editName() {
            const n = prompt("ชื่อใหม่:", currentUser.name);
            if(n) { currentUser.name = n; localStorage.setItem('currUser', JSON.stringify(currentUser)); renderProfile(); }
        }

        // --- ROOMS ---
        function createRoom() {
            const id = Math.floor(1000 + Math.random() * 9000).toString();
            let rooms = JSON.parse(localStorage.getItem('myRooms') || "[]");
            rooms.unshift({ id, date: new Date().toLocaleDateString() });
            localStorage.setItem('myRooms', JSON.stringify(rooms)); renderProfile(); joinRoom(id);
        }
        function joinRoomFromInput() { const id = document.getElementById('join-id').value; if(id) joinRoom(id); }

        // --- VIDEO CALL (IOS STABLE) ---
        async function joinRoom(roomId) {
            if(AGORA_APP_ID.length < 10) return alert("⚠️ ใส่ App ID ด้วยครับ");
            
            showScreen('video');
            document.getElementById('room-display').innerText = "ID: " + roomId;
            
            try {
                const uid = await client.join(AGORA_APP_ID, roomId, null, null);
                
                // ⚠️ iOS Fix: ใช้ config แบบธรรมดาเพื่อลดภาระเครื่อง
                try {
                    [localTracks.audio, localTracks.video] = await AgoraRTC.createMicrophoneAndCameraTracks(
                        { encoderConfig: "music_standard" },
                        { encoderConfig: "360p_1" } // ลดความละเอียดเล็กน้อยเพื่อความเสถียรบน iOS
                    );
                } catch (err) {
                    console.error("Device Error:", err);
                    if(err.name === "NotAllowedError" || err.code === "PERMISSION_DENIED") {
                        alert("❌ ไม่ได้รับอนุญาตให้ใช้กล้อง (Permission Denied)\nกรุณาไปที่ Settings > Safari > Camera > Allow");
                    } else {
                        alert("เกิดข้อผิดพลาดในการเปิดกล้อง: " + err.name + "\n(กรุณาลองรีเฟรชหน้าเว็บ)");
                    }
                    leaveRoom(); return;
                }

                addVideo(uid, localTracks.video, true, false);
                await client.publish([localTracks.audio, localTracks.video]);

            } catch(e) { 
                console.error(e);
                // ไม่สั่ง leaveRoom() ทันทีถ้าเป็น Error เล็กน้อย เพื่อป้องกันการเด้งออกโดยไม่จำเป็น
                if(e.code === "UID_CONFLICT" || e.code === "INVALID_TOKEN") {
                    alert("การเชื่อมต่อมีปัญหา: " + e.code);
                    leaveRoom();
                }
            }
        }

        client.on("user-published", async (user, mediaType) => {
            await client.subscribe(user, mediaType);
            remoteUsers[user.uid] = user;
            if(mediaType === "video") addVideo(user.uid, user.videoTrack, false, false);
            if(mediaType === "audio") {
                // ⚠️ iOS Fix: ป้องกัน Audio Autoplay Error
                try {
                    user.audioTrack.play();
                } catch(err) { console.log("Audio Play Failed (iOS Restriction)"); }
                
                if(!isSpeakerOn) user.audioTrack.setVolume(0);
            }
            updateGrid();
        });
        client.on("user-unpublished", (user, mediaType) => { if(mediaType === "video") removeVideo(user.uid); });
        client.on("user-left", (user) => { delete remoteUsers[user.uid]; removeVideo(user.uid); });

        function addVideo(uid, track, isLocal, isScreen) {
            if(document.getElementById(`vid-wrap-${uid}`)) return;
            const div = document.createElement('div');
            div.className = 'video-item';
            div.id = `vid-wrap-${uid}`;
            div.innerHTML = `<div id="play-${uid}" class="video-player ${isScreen?'screen-share':''}"></div><div class="name-label">${isLocal ? 'Me' : 'User ' + uid}</div>`;
            document.getElementById('video-grid').appendChild(div);
            track.play(`play-${uid}`); updateGrid();
        }
        function removeVideo(uid) { const el = document.getElementById(`vid-wrap-${uid}`); if(el) el.remove(); updateGrid(); }
        function updateGrid() {
            const grid = document.getElementById('video-grid');
            const count = grid.children.length;
            grid.className = 'video-grid';
            if(window.innerWidth > 768) {
                if(count <= 1) grid.classList.add('grid-1');
                else if(count === 2) grid.classList.add('grid-2');
                else if(count <= 4) grid.classList.add('grid-4');
                else grid.classList.add('grid-6');
            }
        }

        function leaveRoom() {
            if(localTracks.audio) localTracks.audio.close();
            if(localTracks.video) localTracks.video.close();
            if(localTracks.screen) localTracks.screen.close();
            client.leave(); remoteUsers = {}; localTracks = {}; isScreenSharing = false;
            document.getElementById('video-grid').innerHTML = ''; showScreen('dashboard');
        }

        function toggleMic() {
            if(localTracks.audio) { localTracks.audio.setMuted(!localTracks.audio.muted); btnStyle('btn-mic', !localTracks.audio.muted); }
        }
        function toggleCam() {
            if(localTracks.video) { localTracks.video.setMuted(!localTracks.video.muted); btnStyle('btn-cam', !localTracks.video.muted); }
        }
        function toggleSpeaker() {
            isSpeakerOn = !isSpeakerOn; btnStyle('btn-vol', isSpeakerOn);
            Object.values(remoteUsers).forEach(u => { if(u.audioTrack) u.audioTrack.setVolume(isSpeakerOn ? 100 : 0); });
        }
        
        async function toggleShare() {
            try {
                if(!isScreenSharing) {
                    localTracks.screen = await AgoraRTC.createScreenVideoTrack({
                        encoderConfig: "720p_1" // Safe for mobile sharing
                    });
                    await client.unpublish(localTracks.video); removeVideo(client.uid);
                    addVideo(client.uid, localTracks.screen, true, true);
                    await client.publish(localTracks.screen);
                    isScreenSharing = true; btnStyle('btn-screen', true);
                    localTracks.screen.on("track-ended", toggleShare);
                } else {
                    await client.unpublish(localTracks.screen); localTracks.screen.close();
                    removeVideo(client.uid); addVideo(client.uid, localTracks.video, true, false);
                    await client.publish(localTracks.video); isScreenSharing = false; btnStyle('btn-screen', false);
                }
            } catch(e) { console.error(e); alert("การแชร์หน้าจอถูกยกเลิก หรือไม่รองรับ"); }
        }

        function btnStyle(id, on) {
            const el = document.getElementById(id);
            if(on) { el.classList.add('active'); el.classList.remove('off'); }
            else { el.classList.add('off'); el.classList.remove('active'); }
        }
    </script>
</body>
</html>