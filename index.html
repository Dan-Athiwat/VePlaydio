<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V-Tok Ultimate V3</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEME --- */
        :root { --bg: #121212; --text: #fff; --accent: #25F4EE; --accent-2: #FE2C55; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Kanit', sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* --- LOADING SPLASH --- */
        #splash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .spinner { width: 50px; height: 50px; border-radius: 50%; border: 5px solid transparent; border-top-color: var(--accent); border-bottom-color: var(--accent-2); animation: spin 0.8s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- PAGES --- */
        .page { position: absolute; top:0; left:0; width:100%; height:100%; display: none; background: #000; z-index: 10; padding-bottom: 55px; }
        .page.active { display: block; z-index: 20; }
        
        /* --- FEED UI --- */
        #feed-container { overflow-y: scroll; scroll-snap-type: y mandatory; height: 100%; scrollbar-width: none; }
        .video-card { width: 100%; height: 100%; scroll-snap-align: start; position: relative; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }

        .top-nav { position: fixed; top: 25px; width: 100%; display: flex; justify-content: center; align-items: center; z-index: 50; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); }
        .nav-tab { opacity: 0.6; margin: 0 15px; font-weight: bold; cursor: pointer; }
        .nav-tab.active { opacity: 1; border-bottom: 2px solid white; padding-bottom: 2px; }
        .search-btn { position: absolute; right: 20px; font-size: 20px; cursor: pointer; }

        /* --- ACTION SIDEBAR --- */
        .sidebar { position: absolute; right: 10px; bottom: 100px; display: flex; flex-direction: column; gap: 20px; align-items: center; z-index: 30; }
        .btn-icon { display: flex; flex-direction: column; align-items: center; text-align: center; cursor: pointer; }
        .btn-icon i { font-size: 28px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); transition: transform 0.2s; color: white;}
        .btn-icon:active i { transform: scale(0.8); }
        .btn-icon span { font-size: 12px; font-weight: 600; text-shadow: 1px 1px 2px black; margin-top: 3px; }
        .liked i { color: var(--accent-2); }
        .saved i { color: gold; }
        .reposted i { color: var(--accent); }

        .avatar-wrap { position: relative; margin-bottom: 10px; }
        .avatar-img { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; object-fit: cover; }
        .follow-plus { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); background: var(--accent-2); width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 10px; color: white; }

        /* --- DISC ANIMATION --- */
        .disc-wrap { width: 45px; height: 45px; background: #222; border-radius: 50%; border: 8px solid #111; display: flex; justify-content: center; align-items: center; animation: spinDisc 5s linear infinite; margin-top: 10px; cursor: pointer; }
        .disc-wrap img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        @keyframes spinDisc { 100% { transform: rotate(360deg); } }

        /* --- BOTTOM INFO --- */
        .bottom-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px 80px 70px 15px; background: linear-gradient(transparent, rgba(0,0,0,0.9)); pointer-events: none; }
        .info-content { pointer-events: auto; }
        .username { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; cursor: pointer; }
        .desc { font-size: 14px; margin-bottom: 5px; line-height: 1.4; }
        .date { font-size: 10px; color: #ccc; margin-bottom: 5px; }
        .sound-tag { font-size: 13px; display: flex; align-items: center; gap: 5px; }

        /* --- BOTTOM BAR --- */
        .navbar { position: fixed; bottom: 0; width: 100%; height: 55px; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { font-size: 22px; color: #777; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-item.active { color: #fff; }
        .nav-item span { font-size: 9px; margin-top: 3px; }
        
        .upload-btn { width: 45px; height: 30px; background: linear-gradient(to right, var(--accent), var(--accent-2)); border-radius: 8px; display: flex; justify-content: center; align-items: center; }
        .upload-btn i { background: white; color: black; width: 37px; height: 100%; display: flex; justify-content: center; align-items: center; border-radius: 4px; font-size: 14px; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: #222; padding: 25px; width: 85%; border-radius: 12px; border: 1px solid #333; text-align: center; position: relative; }
        input, textarea { width: 100%; background: #333; border: none; padding: 12px; color: white; border-radius: 8px; margin: 10px 0; }
        .btn-primary { width: 100%; padding: 12px; background: var(--accent-2); border: none; color: white; font-weight: bold; border-radius: 5px; margin-top: 10px; }
        
        /* --- PROFILE --- */
        .profile-header { padding: 40px 20px 10px; text-align: center; position: relative; }
        .p-img { width: 90px; height: 90px; border-radius: 50%; object-fit: cover; border: 2px solid #333; }
        .stats { display: flex; justify-content: center; gap: 30px; margin: 15px 0; }
        .btn-edit { padding: 8px 30px; background: #333; color: white; border: 1px solid #444; border-radius: 4px; font-weight: bold; }
        .btn-follow { padding: 8px 30px; background: var(--accent-2); color: white; border: none; border-radius: 4px; font-weight: bold; }
        
        .profile-tabs { display: flex; border-top: 1px solid #333; border-bottom: 1px solid #333; margin-top: 10px; }
        .pt-item { flex: 1; text-align: center; padding: 12px; color: #777; cursor: pointer; }
        .pt-item.active { color: white; border-bottom: 2px solid white; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; }
        .grid-item { aspect-ratio: 3/4; background: #111; position: relative; }
        .grid-item video { width: 100%; height: 100%; object-fit: cover; }

        /* --- SOUND PAGE --- */
        #sound-page-header { padding: 20px; display: flex; align-items: center; gap: 15px; background: #111; }
        .use-sound-btn { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--accent-2); color: white; padding: 12px 40px; border-radius: 30px; font-weight: bold; z-index: 50; display: flex; align-items: center; gap: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }

        /* --- SEARCH PAGE --- */
        .search-bar { display: flex; gap: 10px; padding: 15px; background: #000; }
        .search-input { margin: 0; background: #222; }

        /* --- MENU SETTINGS --- */
        .menu-popup { position: absolute; top: 50px; right: 20px; background: #222; border-radius: 8px; width: 180px; display: none; z-index: 99; border: 1px solid #444; }
        .menu-item { padding: 12px; border-bottom: 1px solid #333; font-size: 14px; text-align: left; cursor: pointer; }
    </style>
</head>
<body>

    <div id="splash"><div class="spinner"></div></div>

    <div id="feed-page" class="page active">
        <div class="top-nav">
            <div class="nav-tab" id="tab-follow" onclick="loadFeed('following')">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
            <div class="nav-tab active" id="tab-popular" onclick="loadFeed('popular')">‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
            <div class="search-btn" onclick="openSearch()"><i class="fas fa-search"></i></div>
        </div>
        <div id="feed-container"></div>
    </div>

    <div id="search-page" class="page">
        <div class="search-bar">
            <i class="fas fa-arrow-left" style="align-self:center; font-size:20px;" onclick="closeSearch()"></i>
            <input type="text" id="search-input" class="search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ñ‡∏•‡∏¥‡∏õ...">
            <button onclick="doSearch()" style="background:var(--accent-2); border:none; color:white; padding:0 15px; border-radius:8px;">‡∏ï‡∏Å‡∏•‡∏á</button>
        </div>
        <div id="search-results" class="grid"></div>
    </div>

    <div id="upload-page" class="page" style="background:#111;">
        <div style="padding:20px; text-align:center;">
            <h3>‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà</h3>
            <div id="upload-sound-info" style="font-size:12px; color:var(--accent); margin-bottom:10px;"></div>
            <input type="file" id="up-file" accept="video/*">
            <input type="text" id="up-title" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏õ...">
            <textarea id="up-desc" rows="3" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢..."></textarea>
            <div id="up-progress" style="height:5px; background:#333; margin-top:10px;"><div id="up-bar" style="height:100%; width:0%; background:var(--accent-2);"></div></div>
            <button class="btn-primary" onclick="startUpload()">‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</button>
            <button onclick="goBack()" style="background:transparent; color:#888; border:none; margin-top:10px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="sound-page" class="page">
        <div id="sound-page-header">
            <i class="fas fa-arrow-left" onclick="goBack()"></i>
            <div style="width:60px; height:60px; background:#222; display:flex; justify-content:center; align-items:center; border-radius:8px;"><i class="fas fa-music"></i></div>
            <div>
                <h3 id="sp-name" style="margin:0;">Sound Name</h3>
                <div style="font-size:12px; color:#888;">‡∏Ñ‡∏•‡∏¥‡∏õ‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°</div>
            </div>
        </div>
        <div id="sound-grid" class="grid"></div>
        <div class="use-sound-btn" onclick="useThisSound()">
            <i class="fas fa-video"></i> ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ô‡∏µ‡πâ
        </div>
    </div>

    <div id="profile-page-ui" class="page" style="overflow-y:auto;">
        <div class="profile-header">
            <div style="position:absolute; top:15px; right:15px;" onclick="toggleMenu()"><i class="fas fa-bars"></i></div>
            <div id="settings-menu" class="menu-popup">
                <div class="menu-item" onclick="togglePrivacy()">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡∏ã‡πà‡∏≠‡∏ô‡πÉ‡∏à)</div>
                <div class="menu-item" onclick="alert('‡∏õ‡∏¥‡∏î UI')">‡∏õ‡∏¥‡∏î UI</div>
                <div class="menu-item" style="color:var(--accent-2);" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            </div>

            <img id="p-img" src="" class="p-img">
            <h2 id="p-name" style="margin:10px 0;">...</h2>
            <div class="stats">
                <div><b id="s-following">0</b><br><span style="font-size:10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</span></div>
                <div><b id="s-followers">0</b><br><span style="font-size:10px;">‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</span></div>
                <div><b id="s-likes">0</b><br><span style="font-size:10px;">‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</span></div>
            </div>
            <div id="p-actions"></div>
        </div>
        <div class="profile-tabs">
            <div class="pt-item active" onclick="switchTab('clips')"><i class="fas fa-th"></i></div>
            <div class="pt-item" onclick="switchTab('reposts')"><i class="fas fa-retweet"></i></div>
            <div class="pt-item" onclick="switchTab('likes')"><i class="fas fa-heart"></i></div>
        </div>
        <div id="profile-grid" class="grid"></div>
    </div>

    <div class="navbar" id="navbar">
        <div class="nav-item active" onclick="goPage('feed-page')"><i class="fas fa-home"></i><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></div>
        <div class="nav-item" onclick="alert('‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô')"><i class="fas fa-user-friends"></i><span>‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô</span></div>
        <div class="nav-item" onclick="openUploadNormal()"><div class="upload-btn"><i class="fas fa-plus"></i></div></div>
        <div class="nav-item" onclick="alert('‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°')"><i class="far fa-comment-dots"></i><span>‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</span></div>
        <div class="nav-item" onclick="openMyProfile()"><i class="far fa-user"></i><span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö V-Tok</h2>
            <button class="btn-primary" style="background:white; color:black;" onclick="loginGoogle()">
                <i class="fab fa-google"></i> Login Google
            </button>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
            <p style="font-size:10px; color:#aaa;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô</p>
            <input type="text" id="ed-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà">
            <button class="btn-primary" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button onclick="closeModal('edit-modal')" style="background:none; border:none; color:#888; margin-top:10px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, doc, query, orderBy, limit, where, updateDoc, arrayUnion, arrayRemove, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // --- CONFIG ---
        const firebaseConfig = {
  apiKey: "AIzaSyB575txzpvEoiUPGAzMWmBIJ-AumUrPZ04",
  authDomain: "mychatapp-6553a.firebaseapp.com",
  databaseURL: "https://mychatapp-6553a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mychatapp-6553a",
  storageBucket: "mychatapp-6553a.firebasestorage.app",
  messagingSenderId: "327022378740",
  appId: "1:327022378740:web:381b0688ed36b48a90e8a1",
  measurementId: "G-X4LL87Q0Z4"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        let currentUser = null;
        let selectedSound = null; // { id, name }
        let currentProfileUid = null;

        // --- LOAD FAST ---
        setTimeout(() => { document.getElementById('splash').style.opacity=0; setTimeout(()=>document.getElementById('splash').style.display='none',500); }, 1500);

        // --- AUTH ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('login-modal').style.display='none';
                // Init User
                const uRef = doc(db, "users", user.uid);
                const s = await getDoc(uRef);
                if(!s.exists()) {
                    await setDoc(uRef, {
                        uid: user.uid,
                        displayName: user.displayName,
                        photoURL: user.photoURL,
                        followers: [], following: [],
                        likesReceived: 0,
                        lastInfoChange: 0,
                        settings: { hideLikes: false }
                    });
                }
            } else {
                document.getElementById('login-modal').style.display='flex';
            }
        });

        window.loginGoogle = () => signInWithPopup(auth, new GoogleAuthProvider()).catch(e=>alert(e.message));
        window.logout = () => signOut(auth).then(()=>location.reload());

        // --- FEED ---
        const feedObs = new IntersectionObserver((e)=>{
            e.forEach(i=>{
                const v = i.target;
                if(i.isIntersecting){ v.src=v.dataset.src; v.load(); v.play().catch(()=>{}); }
                else { v.pause(); }
            });
        }, {threshold:0.6});

        window.loadFeed = async (type='popular') => {
            const con = document.getElementById('feed-container');
            document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
            document.getElementById(type=='popular'?'tab-popular':'tab-follow').classList.add('active');
            
            con.innerHTML = "";
            let q = query(collection(db, "videos"), orderBy("timestamp", "desc"), limit(10));
            // Note: 'following' feed requires complex index, using standard feed for demo stability
            const snaps = await getDocs(q);
            snaps.forEach(d => renderVideo(d.data(), d.id, con));
        };

        function renderVideo(d, id, con) {
            const el = document.createElement('div');
            el.className = 'video-card';
            const date = new Date(d.timestamp).toLocaleDateString('th-TH');
            const isLiked = d.likes && d.likes.includes(currentUser?.uid);
            const isSaved = d.saves && d.saves.includes(currentUser?.uid);
            const isReposted = d.reposts && d.reposts.includes(currentUser?.uid);

            el.innerHTML = `
                <video data-src="${d.videoUrl}" loop playsinline onclick="togglePlay(this)"></video>
                <div class="sidebar">
                    <div class="avatar-wrap" onclick="openProfile('${d.uid}')">
                        <img src="${d.userPhoto}" class="avatar-img">
                        ${(currentUser?.uid !== d.uid) ? '<div class="follow-plus"><i class="fas fa-plus"></i></div>' : ''}
                    </div>
                    <div class="btn-icon ${isLiked?'liked':''}" onclick="doAction('${id}','like',this)">
                        <i class="fas fa-heart"></i><span>${d.likes?.length||0}</span>
                    </div>
                    <div class="btn-icon" onclick="alert('‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå')">
                        <i class="fas fa-comment-dots"></i><span>0</span>
                    </div>
                    <div class="btn-icon ${isSaved?'saved':''}" onclick="doAction('${id}','save',this)">
                        <i class="fas fa-bookmark"></i><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                    </div>
                    <div class="btn-icon ${isReposted?'reposted':''}" onclick="doAction('${id}','repost',this)">
                        <i class="fas fa-retweet"></i><span>‡∏£‡∏µ‡πÇ‡∏û‡∏™‡∏ï‡πå</span>
                    </div>
                    <div class="btn-icon"><i class="fas fa-share"></i><span>‡πÅ‡∏ä‡∏£‡πå</span></div>
                    <div class="disc-wrap" onclick="openSound('${d.soundId}','${d.soundName}')"><img src="${d.userPhoto}"></div>
                </div>
                <div class="bottom-info">
                    <div class="info-content">
                        <div class="username" onclick="openProfile('${d.uid}')">@${d.username}</div>
                        <div class="desc">${d.desc}</div>
                        <div class="date">${date} ‚Ä¢ ${d.title || '‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠'}</div>
                        <div class="sound-tag"><i class="fas fa-music"></i> ${d.soundName || '‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö'}</div>
                    </div>
                </div>
            `;
            con.appendChild(el);
            feedObs.observe(el.querySelector('video'));
        }

        window.togglePlay = (v) => v.paused ? v.play() : v.pause();

        window.doAction = async (vid, type, btn) => {
            if(!currentUser) return;
            const ref = doc(db, "videos", vid);
            let field = type+'s'; // likes, saves, reposts
            const isActive = btn.classList.contains(type=='like'?'liked':(type=='save'?'saved':'reposted'));
            
            // UI Update
            btn.classList.toggle(type=='like'?'liked':(type=='save'?'saved':'reposted'));
            if(type=='like'){
                let sp = btn.querySelector('span');
                sp.innerText = parseInt(sp.innerText) + (isActive ? -1 : 1);
            }

            // DB Update
            await updateDoc(ref, { [field]: isActive ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
            
            // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏î‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï stats ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏•‡∏¥‡∏õ‡∏î‡πâ‡∏ß‡∏¢
            if(type=='like') {
                const vidSnap = await getDoc(ref);
                const ownerUid = vidSnap.data().uid;
                await updateDoc(doc(db, "users", ownerUid), { likesReceived: increment(isActive ? -1 : 1) });
            }
        };

        // --- UPLOAD & SOUND ---
        window.openUploadNormal = () => { selectedSound = null; openPage('upload-page'); };
        
        window.openSound = async (sid, sname) => {
            selectedSound = { id: sid, name: sname };
            document.getElementById('sp-name').innerText = sname;
            openPage('sound-page');
            
            const g = document.getElementById('sound-grid');
            g.innerHTML = "Loading...";
            const q = query(collection(db, "videos"), where("soundId", "==", sid), limit(12));
            const snaps = await getDocs(q);
            g.innerHTML = "";
            snaps.forEach(d => {
                g.innerHTML += `<div class="grid-item"><video src="${d.data().videoUrl}#t=1"></video></div>`;
            });
        };

        window.useThisSound = () => {
            openPage('upload-page');
            document.getElementById('upload-sound-info').innerText = `üéµ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á: ${selectedSound.name}`;
        };

        window.startUpload = () => {
            const file = document.getElementById('up-file').files[0];
            const title = document.getElementById('up-title').value;
            const desc = document.getElementById('up-desc').value;
            
            if(!file) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô");
            if(file.size > 200 * 1024 * 1024) return alert("‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô 200MB"); // Limit for stability
            
            // Logic ‡πÄ‡∏™‡∏µ‡∏¢‡∏á
            const soundId = selectedSound ? selectedSound.id : "random_" + Date.now();
            const soundName = selectedSound ? selectedSound.name : "‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Æ‡∏¥‡∏ï‡πÉ‡∏ô‡∏Å‡∏£‡∏∞‡πÅ‡∏™";

            const sRef = ref(storage, `videos/${Date.now()}_${currentUser.uid}`);
            const task = uploadBytesResumable(sRef, file);

            task.on('state_changed', (s)=>{
                document.getElementById('up-bar').style.width = ((s.bytesTransferred/s.totalBytes)*100)+'%';
            }, null, async ()=>{
                const url = await getDownloadURL(task.snapshot.ref);
                await addDoc(collection(db, "videos"), {
                    uid: currentUser.uid,
                    username: currentUser.displayName,
                    userPhoto: currentUser.photoURL,
                    videoUrl: url,
                    title: title, desc: desc,
                    soundId: soundId, soundName: soundName,
                    likes: [], saves: [], reposts: [],
                    timestamp: Date.now()
                });
                alert("‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!");
                loadFeed();
                goPage('feed-page');
            });
        };

        // --- SEARCH ---
        window.openSearch = () => openPage('search-page');
        window.closeSearch = () => goBack();
        window.doSearch = async () => {
            const txt = document.getElementById('search-input').value;
            const res = document.getElementById('search-results');
            res.innerHTML = "Searching...";
            // Note: Firebase basic search only supports exact match or prefix. For full text, need Algolia.
            // This demo simulates search by querying recent videos.
            const q = query(collection(db, "videos"), limit(20));
            const snaps = await getDocs(q);
            res.innerHTML = "";
            snaps.forEach(d => {
                if(d.data().desc.includes(txt) || d.data().title.includes(txt)) {
                    res.innerHTML += `<div class="grid-item" onclick="alert('‡πÄ‡∏•‡πà‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ')"><video src="${d.data().videoUrl}#t=1"></video></div>`;
                }
            });
            if(res.innerHTML == "") res.innerHTML = "<p style='width:100%; text-align:center;'>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</p>";
        };

        // --- PROFILE ---
        window.openMyProfile = () => openProfile(currentUser.uid);
        
        window.openProfile = async (uid) => {
            currentProfileUid = uid;
            goPage('profile-page-ui');
            
            const uSnap = await getDoc(doc(db, "users", uid));
            const u = uSnap.data();
            const isMe = currentUser.uid === uid;

            document.getElementById('p-img').src = u.photoURL;
            document.getElementById('p-name').innerText = "@" + u.displayName;
            document.getElementById('s-following').innerText = u.following?.length || 0;
            document.getElementById('s-followers').innerText = u.followers?.length || 0;
            document.getElementById('s-likes').innerText = u.likesReceived || 0;

            const actDiv = document.getElementById('p-actions');
            if(isMe) {
                actDiv.innerHTML = `<button class="btn-edit" onclick="openEditModal('${u.displayName}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</button>`;
            } else {
                const isFollow = u.followers && u.followers.includes(currentUser.uid);
                actDiv.innerHTML = `<button class="btn-follow" onclick="followUser('${uid}')">${isFollow?'‡πÄ‡∏•‡∏¥‡∏Å‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°':'‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°'}</button>`;
            }

            switchTab('clips');
        };

        window.switchTab = async (tab) => {
            const grid = document.getElementById('profile-grid');
            document.querySelectorAll('.pt-item').forEach(e=>e.classList.remove('active'));
            // Highlight tab logic... (skipped for brevity)
            
            grid.innerHTML = "Loading...";
            let q;
            // Privacy Check
            if(tab === 'likes') {
                const uSnap = await getDoc(doc(db, "users", currentProfileUid));
                if(currentProfileUid !== currentUser.uid && uSnap.data().settings?.hideLikes) {
                    grid.innerHTML = "<p style='width:300%; text-align:center; padding:20px; color:#666;'>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ã‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏¥‡∏õ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</p>";
                    return;
                }
                q = query(collection(db, "videos"), where("likes", "array-contains", currentProfileUid));
            } else if (tab === 'reposts') {
                q = query(collection(db, "videos"), where("reposts", "array-contains", currentProfileUid));
            } else {
                q = query(collection(db, "videos"), where("uid", "==", currentProfileUid));
            }

            const snaps = await getDocs(q);
            grid.innerHTML = "";
            snaps.forEach(d => {
                grid.innerHTML += `<div class="grid-item"><video src="${d.data().videoUrl}#t=1"></video></div>`;
            });
        };

        window.openEditModal = (oldName) => {
            document.getElementById('ed-name').value = oldName;
            document.getElementById('edit-modal').style.display='flex';
        };

        window.saveProfile = async () => {
            const newName = document.getElementById('ed-name').value;
            const uRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(uRef);
            const last = snap.data().lastInfoChange || 0;
            
            // 7 Days Check (604800000 ms)
            if(Date.now() - last < 604800000) return alert("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô");
            
            await updateProfile(currentUser, { displayName: newName });
            await updateDoc(uRef, { displayName: newName, lastInfoChange: Date.now() });
            document.getElementById('edit-modal').style.display='none';
            openProfile(currentUser.uid);
        };

        window.togglePrivacy = async () => {
            const uRef = doc(db, "users", currentUser.uid);
            const snap = await getDoc(uRef);
            const current = snap.data().settings?.hideLikes || false;
            await updateDoc(uRef, { "settings.hideLikes": !current });
            alert(`‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÉ‡∏à: ${!current ? '‡πÄ‡∏õ‡∏¥‡∏î' : '‡∏õ‡∏¥‡∏î'}`);
        };

        window.followUser = async (targetUid) => {
            const myRef = doc(db, "users", currentUser.uid);
            const targetRef = doc(db, "users", targetUid);
            // Simple toggle follow logic (In prod, check existence first)
            await updateDoc(targetRef, { followers: arrayUnion(currentUser.uid) });
            await updateDoc(myRef, { following: arrayUnion(targetUid) });
            openProfile(targetUid); // Refresh
        };

        // --- UTILS ---
        window.goPage = (p) => {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            if(p=='feed-page') loadFeed();
        };
        window.goBack = () => goPage('feed-page');
        window.toggleMenu = () => { const m=document.getElementById('settings-menu'); m.style.display=m.style.display=='block'?'none':'block'; };
        window.closeModal = (id) => document.getElementById(id).style.display='none';

        // Init
        loadFeed();

    </script>
</body>
</html>