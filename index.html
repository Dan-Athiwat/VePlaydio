<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>V-Tok Final (2GB Support)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CORE THEME (TIKTOK STYLE) --- */
        :root {
            --bg: #121212;
            --nav-bg: #000;
            --text: #fff;
            --accent: #25F4EE; /* Cyan */
            --accent-2: #FE2C55; /* Red */
            --gray: #888;
            --glass: rgba(20, 20, 20, 0.85);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: 'Kanit', sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }

        /* --- LOADING SCREEN (SKELETON) --- */
        #splash-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; transition: opacity 0.5s; }
        .tiktok-loader { width: 50px; height: 50px; border-radius: 50%; border: 5px solid transparent; border-top-color: var(--accent); border-bottom-color: var(--accent-2); animation: spin 0.8s linear infinite; }
        
        /* --- PAGE MANAGER --- */
        .page { position: absolute; top:0; left:0; width:100%; height:100%; display: none; background: var(--bg); z-index: 10; padding-bottom: 50px; }
        .page.active { display: block; z-index: 20; }
        
        /* --- FEED STYLES --- */
        #feed-container { overflow-y: scroll; scroll-snap-type: y mandatory; height: 100%; background: #000; scrollbar-width: none; }
        .video-card { width: 100%; height: 100%; scroll-snap-align: start; position: relative; background: #000; overflow: hidden; }
        
        /* Optimize Video Loading */
        video { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.3s; }
        video.ready { opacity: 1; }

        /* Feed Tabs */
        .top-tabs { position: fixed; top: 25px; width: 100%; display: flex; justify-content: center; gap: 20px; z-index: 50; text-shadow: 1px 1px 3px rgba(0,0,0,0.8); font-weight: bold; font-size: 1.1rem; }
        .tab-item { opacity: 0.6; transition: 0.3s; cursor: pointer; position: relative;}
        .tab-item.active { opacity: 1; color: #fff; }
        .tab-item.active::after { content:''; position:absolute; bottom:-5px; left:50%; transform:translateX(-50%); width: 20px; height: 2px; background: #fff; }

        /* Actions Sidebar */
        .right-actions { position: absolute; right: 8px; bottom: 120px; display: flex; flex-direction: column; gap: 18px; align-items: center; z-index: 30; }
        .action-btn { display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .action-btn:active { transform: scale(0.9); }
        .action-btn i { font-size: 28px; filter: drop-shadow(0 2px 5px rgba(0,0,0,0.5)); margin-bottom: 3px; color: white; transition: color 0.2s;}
        .action-btn span { font-size: 11px; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.8); }
        .liked i { color: var(--accent-2) !important; }
        .saved i { color: #FFD700 !important; }

        /* Avatar & Follow */
        .avatar-container { position: relative; margin-bottom: 15px; }
        .avatar-feed { width: 48px; height: 48px; border-radius: 50%; border: 1px solid #fff; object-fit: cover; }
        .follow-plus { position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%); width: 22px; height: 22px; background: var(--accent-2); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 12px; color: white; }

        /* Disc Animation */
        .disc-area { width: 45px; height: 45px; background: #222; border-radius: 50%; border: 8px solid #181818; display: flex; justify-content: center; align-items: center; animation: spin 5s linear infinite; overflow: hidden; margin-top: 10px; }
        .disc-area img { width: 100%; height: 100%; object-fit: cover; border-radius: 50%; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Bottom Info */
        .bottom-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 20px 80px 75px 15px; background: linear-gradient(to top, rgba(0,0,0,0.9), transparent); pointer-events: none; }
        .info-txt { pointer-events: auto; }
        .music-ticker { font-size: 13px; display: flex; align-items: center; gap: 5px; margin-top: 5px; }

        /* --- PROFILE PAGE --- */
        #profile-page-ui { overflow-y: auto; }
        .profile-header { padding: 80px 20px 20px; text-align: center; }
        .p-img { width: 96px; height: 96px; border-radius: 50%; object-fit: cover; border: 2px solid #222; }
        .stats-row { display: flex; justify-content: center; gap: 35px; margin: 20px 0; }
        .stat-item b { font-size: 18px; display: block; }
        .stat-item span { font-size: 12px; color: var(--gray); }
        .btn-row { display: flex; justify-content: center; gap: 5px; margin-bottom: 20px; }
        .btn-edit { background: #333; color: white; border: 1px solid #444; padding: 10px 30px; border-radius: 4px; font-weight: 600; font-size: 14px; }
        
        .profile-tabs { display: flex; justify-content: space-around; border-top: 1px solid #222; border-bottom: 1px solid #222; background: var(--bg); position: sticky; top: 0; z-index: 40; height: 45px; align-items: center;}
        .p-tab { color: #666; cursor: pointer; flex: 1; text-align: center; height: 100%; display: flex; justify-content: center; align-items: center;}
        .p-tab.active { color: #fff; border-bottom: 2px solid #fff; }
        
        .grid-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px; }
        .grid-item { aspect-ratio: 3/4; background: #1a1a1a; position: relative; cursor: pointer; }
        .grid-item img, .grid-item video { width: 100%; height: 100%; object-fit: cover; }

        /* --- CHAT PAGE --- */
        .chat-header { padding: 15px; border-bottom: 1px solid #333; font-weight: bold; display: flex; justify-content: space-between; align-items: center; background: var(--bg); }
        .chat-list-item { padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; transition: 0.2s; }
        .chat-list-item:active { background: #222; }
        
        /* Chat Room */
        #chat-room { background: #000; z-index: 100; display: flex; flex-direction: column; }
        .room-header { padding: 10px 15px; background: #111; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #222; }
        .room-msgs { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        .msg-bubble { max-width: 75%; padding: 8px 12px; border-radius: 18px; font-size: 14px; word-wrap: break-word; }
        .msg-me { align-self: flex-end; background: var(--accent); color: #000; border-bottom-right-radius: 4px; }
        .msg-you { align-self: flex-start; background: #333; color: #fff; border-bottom-left-radius: 4px; }
        .room-input { padding: 10px; background: #111; display: flex; gap: 10px; align-items: center; }
        
        /* --- BOTTOM NAVBAR --- */
        .navbar { position: fixed; bottom: 0; left: 0; width: 100%; height: 52px; background: #000; border-top: 1px solid #222; display: flex; justify-content: space-around; align-items: center; z-index: 100; }
        .nav-item { font-size: 20px; color: #666; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; width: 20%; height: 100%; }
        .nav-item.active { color: #fff; }
        .nav-item span { font-size: 10px; margin-top: 2px; }
        
        .upload-btn-container { width: 45px; height: 30px; background: linear-gradient(to right, var(--accent), var(--accent-2)); border-radius: 8px; display: flex; justify-content: center; align-items: center; position: relative; }
        .upload-btn-inner { width: 37px; height: 100%; background: #fff; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-size: 14px; color: #000; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-box { background: #252525; padding: 25px; border-radius: 12px; width: 85%; max-width: 380px; text-align: center; color: white; border: 1px solid #333; position: relative; }
        
        input, textarea { width: 100%; background: #3a3a3a; border: none; padding: 12px; color: white; border-radius: 8px; margin: 10px 0; font-family: 'Kanit'; }
        .btn-main { width: 100%; padding: 12px; background: var(--accent-2); border: none; color: white; font-weight: bold; border-radius: 4px; margin-top: 10px; font-size: 16px; cursor: pointer; }
        .btn-sec { background: transparent; color: #aaa; margin-top: 10px; width: 100%; border: none; padding: 10px; cursor: pointer; }

        /* Progress Bar for 2GB Upload */
        .progress-wrapper { width: 100%; background: #111; height: 8px; border-radius: 4px; margin: 15px 0; overflow: hidden; display: none; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent-2)); width: 0%; transition: width 0.2s; }
        .upload-status { font-size: 12px; color: var(--accent); margin-top: 5px; text-align: right; }

        /* Settings Menu */
        .settings-popup { position: absolute; top: 50px; right: 20px; background: #252525; border-radius: 8px; width: 160px; display: none; z-index: 99; border: 1px solid #444; }
        .settings-item { padding: 12px; border-bottom: 1px solid #333; font-size: 14px; cursor: pointer; text-align: left; }
        .settings-item:last-child { border: none; color: var(--accent-2); }

    </style>
</head>
<body>

    <div id="splash-screen"><div class="tiktok-loader"></div></div>

    <div id="feed-page" class="page active">
        <div class="top-tabs">
            <div class="tab-item" id="t-follow" onclick="switchFeed('follow')">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</div>
            <div class="tab-item active" id="t-foryou" onclick="switchFeed('foryou')">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì</div>
        </div>
        <div id="feed-container"></div>
    </div>

    <div id="search-page" class="page">
        <div style="padding:15px;">
            <div style="position:relative;">
                <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏£‡∏∞‡πÅ‡∏™..." style="background:#222; padding-left:40px;">
                <i class="fas fa-search" style="position:absolute; left:12px; top:24px; color:#666;"></i>
            </div>
            <h3 style="margin-top:20px;">üî• ‡∏°‡∏≤‡πÅ‡∏£‡∏á‡πÉ‡∏ô‡πÑ‡∏ó‡∏¢</h3>
            <div style="display:flex; flex-wrap:wrap; gap:10px;">
                <div style="background:#222; padding:8px 15px; border-radius:20px;">#‡∏™‡∏á‡∏Å‡∏£‡∏≤‡∏ô‡∏ï‡πå</div>
                <div style="background:#222; padding:8px 15px; border-radius:20px;">#‡πÄ‡∏Å‡∏°</div>
                <div style="background:#222; padding:8px 15px; border-radius:20px;">#‡πÄ‡∏ï‡πâ‡∏ô</div>
            </div>
        </div>
    </div>

    <div id="chat-page" class="page">
        <div class="chat-header">
            <span>‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</span>
            <i class="fas fa-plus-circle" onclick="alert('‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô')"></i>
        </div>
        <div id="chat-list"></div>
    </div>

    <div id="chat-room" class="page" style="top:100%; transition:top 0.3s; z-index:300;">
        <div class="room-header">
            <i class="fas fa-arrow-left" onclick="closeChat()"></i>
            <img id="chat-u-img" src="" style="width:30px; height:30px; border-radius:50%;">
            <b id="chat-u-name">User</b>
        </div>
        <div id="room-msgs" class="room-msgs"></div>
        <div class="room-input">
            <input type="text" id="msg-input" placeholder="‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." style="margin:0;">
            <i class="fas fa-paper-plane" style="color:var(--accent-2); font-size:20px;" onclick="sendMsg()"></i>
        </div>
    </div>

    <div id="profile-page-ui" class="page">
        <div class="profile-header">
            <div style="position:absolute; top:15px; right:15px; font-size:20px;" onclick="toggleSettings()"><i class="fas fa-bars"></i></div>
            
            <div id="settings-menu" class="settings-popup">
                <div class="settings-item">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á</div>
                <div class="settings-item">‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</div>
                <div class="settings-item" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div>
            </div>

            <img id="my-img" src="" class="p-img">
            <h2 id="my-name" style="margin:10px 0 5px;">@username</h2>
            <div class="stats-row">
                <div class="stat-item"><b>0</b><span>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</span></div>
                <div class="stat-item"><b>0</b><span>‡∏ú‡∏π‡πâ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°</span></div>
                <div class="stat-item"><b>0</b><span>‡∏ñ‡∏π‡∏Å‡πÉ‡∏à</span></div>
            </div>
            <div class="btn-row">
                <div class="btn-edit" onclick="openEditProfile()">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</div>
                <div class="btn-edit"><i class="fas fa-bookmark"></i></div>
            </div>
        </div>
        
        <div class="profile-tabs">
            <div class="p-tab active" onclick="switchPTab('posts')"><i class="fas fa-th"></i></div>
            <div class="p-tab" onclick="switchPTab('likes')"><i class="fas fa-heart"></i></div>
            <div class="p-tab" onclick="switchPTab('saved')"><i class="fas fa-bookmark"></i></div>
        </div>
        <div id="profile-grid" class="grid-container"></div>
    </div>

    <div class="navbar">
        <div class="nav-item active" onclick="goPage('feed-page')"><i class="fas fa-home"></i><span>‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span></div>
        <div class="nav-item" onclick="goPage('search-page')"><i class="fas fa-compass"></i><span>‡∏Ñ‡πâ‡∏ô‡∏û‡∏ö</span></div>
        <div class="nav-item" onclick="checkUpload()">
            <div class="upload-btn-container"><div class="upload-btn-inner"><i class="fas fa-plus"></i></div></div>
        </div>
        <div class="nav-item" onclick="goPage('chat-page')"><i class="far fa-comment-dots"></i><span>‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ç‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤</span></div>
        <div class="nav-item" onclick="goMyProfile()"><i class="far fa-user"></i><span>‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</span></div>
    </div>

    <div id="upload-modal" class="modal">
        <div class="modal-box">
            <h3>‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏•‡∏¥‡∏õ (‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö 2GB)</h3>
            <input type="file" id="up-file" accept="video/*">
            <input type="text" id="up-cap" placeholder="‡πÅ‡∏Ñ‡∏õ‡∏ä‡∏±‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì #hashtag">
            
            <div class="progress-wrapper" id="prog-wrap">
                <div class="progress-fill" id="prog-bar"></div>
            </div>
            <div id="prog-txt" class="upload-status"></div>

            <button class="btn-main" onclick="startUpload()">‡πÇ‡∏û‡∏™‡∏ï‡πå‡πÄ‡∏•‡∏¢</button>
            <button class="btn-sec" onclick="closeModal('upload-modal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="login-modal" class="modal">
        <div class="modal-box">
            <h2>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö V-Tok</h2>
            <button class="btn-main" style="background:#fff; color:#000;" onclick="loginGoogle()">
                <i class="fab fa-google"></i> ‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢ Google
            </button>
        </div>
    </div>

    <div id="edit-modal" class="modal">
        <div class="modal-box">
            <h3>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</h3>
            <input type="text" id="ed-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà">
            <input type="text" id="ed-pic" placeholder="URL ‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå">
            <button class="btn-main" onclick="saveProfile()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            <button class="btn-sec" onclick="closeModal('edit-modal')">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, getDoc, setDoc, doc, query, orderBy, limit, updateDoc, arrayUnion, arrayRemove, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

        // --- ‡πÉ‡∏™‡πà CONFIG ‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ ---
        const firebaseConfig = {
  apiKey: "AIzaSyB575txzpvEoiUPGAzMWmBIJ-AumUrPZ04",
  authDomain: "mychatapp-6553a.firebaseapp.com",
  databaseURL: "https://mychatapp-6553a-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mychatapp-6553a",
  storageBucket: "mychatapp-6553a.firebasestorage.app",
  messagingSenderId: "327022378740",
  appId: "1:327022378740:web:381b0688ed36b48a90e8a1",
  measurementId: "G-X4LL87Q0Z4"
};

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏ö‡∏ö Safe Mode (‡∏Å‡∏±‡∏ô‡∏û‡∏±‡∏á)
        let app, auth, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (e) {
            console.error("Firebase Init Error:", e);
            alert("‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Firebase ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡πá‡∏Ñ Console");
        }

        let currentUser = null;
        let activeChatId = null;

        // --- ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ 1: ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 1.5 ‡∏ß‡∏¥ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ---
        setTimeout(() => {
            const splash = document.getElementById('splash-screen');
            if(splash) {
                splash.style.opacity = 0;
                setTimeout(() => splash.style.display = 'none', 500);
            }
        }, 1500); 

        // --- AUTH SYSTEM ---
        if(auth) {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    closeModal('login-modal');
                    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÜ (‡πÑ‡∏°‡πà‡∏£‡∏≠)
                    const uRef = doc(db, "users", user.uid);
                    getDoc(uRef).then(s => {
                        if(!s.exists()) setDoc(uRef, { uid:user.uid, name:user.displayName, photo:user.photoURL, followers:[], following:[] });
                    }).catch(e => console.log("User Init Skip"));
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà Login ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏î‡πâ‡∏á Modal ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ ‡πÉ‡∏´‡πâ‡∏î‡∏π Feed ‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ
                    // openModal('login-modal'); <--- ‡∏õ‡∏¥‡∏î‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏Å‡πà‡∏≠‡∏ô
                }
            });
        }

        window.loginGoogle = () => {
            if(!auth) return alert("‡∏£‡∏∞‡∏ö‡∏ö‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°");
            signInWithPopup(auth, new GoogleAuthProvider()).catch(e => alert(e.message));
        }
        window.logout = () => signOut(auth).then(() => location.reload());

        // --- SPEED FEED SYSTEM (‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡πâ‡∏≤‡∏á) ---
        const feedObserver = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const vid = entry.target;
                if(entry.isIntersecting) {
                    if(vid.dataset.src) {
                        vid.src = vid.dataset.src;
                        vid.load();
                        vid.play().catch(()=>{});
                        vid.classList.add('ready');
                    }
                } else {
                    vid.pause();
                }
            });
        }, { threshold: 0.6 });

        async function loadFeed() {
            const con = document.getElementById('feed-container');
            
            // ‡πÉ‡∏™‡πà Skeleton (‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤) ‡∏£‡∏≠‡πÑ‡∏ß‡πâ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏•‡∏¢ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß
            if(con.innerHTML === "") {
                con.innerHTML = `
                    <div class="video-card" style="background:#111; display:flex; justify-content:center; align-items:center;">
                        <div style="color:#444;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏•‡∏¥‡∏õ...</div>
                    </div>
                `;
            }

            if(!db) return; // ‡∏ñ‡πâ‡∏≤ Database ‡∏û‡∏±‡∏á ‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î

            try {
                // ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡∏Ñ 2: ‡πÉ‡∏ä‡πâ try-catch ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏´‡∏•‡∏∏‡∏î ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏≤ Index ‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‡πÉ‡∏´‡πâ‡∏Ç‡πâ‡∏≤‡∏°‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
                const q = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(5));
                const snap = await getDocs(q);
                
                if(!snap.empty) {
                    con.innerHTML = ""; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÇ‡∏Ñ‡∏£‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏≠‡∏≠‡∏Å
                    snap.forEach(doc => renderCard(doc.data(), doc.id, con));
                } else {
                    con.innerHTML = `<div style="text-align:center; padding-top:50%; color:#666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏•‡∏¥‡∏õ<br>‡∏Å‡∏î + ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</div>`;
                }

            } catch (e) {
                console.error("Feed Error:", e);
                // ‡∏ñ‡πâ‡∏≤ Error (‡πÄ‡∏ä‡πà‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á Index) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏∏‡∏ô‡∏ï‡∏¥‡πâ‡∏ß
                con.innerHTML = `<div style="text-align:center; padding-top:50%; color:#666;">‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à<br>(‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Firestore Index)</div>`;
            }
        }

        function renderCard(d, id, container) {
            const el = document.createElement('div');
            el.className = 'video-card';
            const liked = d.likes && d.likes.includes(currentUser?.uid);
            
            el.innerHTML = `
                <video data-src="${d.videoUrl}" loop playsinline onclick="togglePlay(this)"></video>
                <div class="right-actions">
                    <div class="avatar-container">
                        <img src="${d.userPhoto || 'https://via.placeholder.com/50'}" class="avatar-feed">
                        ${(currentUser?.uid !== d.uid) ? '<div class="follow-plus"><i class="fas fa-plus"></i></div>' : ''}
                    </div>
                    <div class="action-btn ${liked?'liked':''}" onclick="doLike('${id}', this)">
                        <i class="fas fa-heart"></i><span>${d.likes?.length||0}</span>
                    </div>
                    <div class="action-btn" onclick="alert('‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ó‡πå')"><i class="fas fa-comment-dots"></i><span>0</span></div>
                    <div class="action-btn"><i class="fas fa-share"></i><span>‡πÅ‡∏ä‡∏£‡πå</span></div>
                    <div class="disc-area"><img src="${d.userPhoto || 'https://via.placeholder.com/50'}"></div>
                </div>
                <div class="bottom-info">
                    <div class="info-txt">
                        <h4 style="margin:0; text-shadow:1px 1px 2px black;">@${d.username}</h4>
                        <div style="margin:6px 0; font-size:14px; text-shadow:1px 1px 2px black;">${d.desc}</div>
                        <div class="music-ticker"><i class="fas fa-music"></i> ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö - ${d.username}</div>
                    </div>
                </div>
            `;
            container.appendChild(el);
            feedObserver.observe(el.querySelector('video'));
        }

        window.togglePlay = (v) => { if(v.paused) { v.muted=false; v.play(); } else v.pause(); };

        window.doLike = async (pid, btn) => {
            if(!currentUser) return openModal('login-modal');
            const isLiked = btn.classList.contains('liked');
            btn.classList.toggle('liked'); 
            const span = btn.querySelector('span');
            span.innerText = parseInt(span.innerText) + (isLiked ? -1 : 1);
            try {
                await updateDoc(doc(db, "posts", pid), { likes: isLiked ? arrayRemove(currentUser.uid) : arrayUnion(currentUser.uid) });
            } catch(e) {}
        };

        // --- UPLOAD SYSTEM ---
        window.checkUpload = () => currentUser ? openModal('upload-modal') : openModal('login-modal');

        window.startUpload = () => {
            const file = document.getElementById('up-file').files[0];
            const cap = document.getElementById('up-cap').value;
            if(!file) return alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô");
            
            document.getElementById('prog-wrap').style.display = 'block';
            
            const storageRef = ref(storage, `videos/${Date.now()}_${currentUser.uid}`);
            const task = uploadBytesResumable(storageRef, file);

            task.on('state_changed', 
                (snap) => {
                    const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
                    document.getElementById('prog-bar').style.width = pct + '%';
                    document.getElementById('prog-txt').innerText = `${Math.floor(pct)}%`;
                },
                (err) => alert("Upload Error"),
                async () => {
                    const url = await getDownloadURL(task.snapshot.ref);
                    await addDoc(collection(db, "posts"), {
                        uid: currentUser.uid,
                        username: currentUser.displayName,
                        userPhoto: currentUser.photoURL,
                        videoUrl: url,
                        desc: cap,
                        likes: [],
                        timestamp: Date.now()
                    });
                    setTimeout(() => location.reload(), 1000);
                }
            );
        };

        // --- PROFILE & UTILS ---
        window.goMyProfile = async () => {
            if(!currentUser) return openModal('login-modal');
            goPage('profile-page-ui');
            document.getElementById('my-img').src = currentUser.photoURL;
            document.getElementById('my-name').innerText = currentUser.displayName;
            document.getElementById('ed-name').value = currentUser.displayName;
            document.getElementById('ed-pic').value = currentUser.photoURL;
            
            const grid = document.getElementById('profile-grid');
            grid.innerHTML = "Loading...";
            try {
                // ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡πá‡∏ß (‡∏î‡∏∂‡∏á‡∏°‡∏≤‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏Ñ‡πà‡∏≠‡∏¢‡∏Å‡∏£‡∏≠‡∏á)
                const q = query(collection(db, "posts"), limit(20));
                const snap = await getDocs(q);
                grid.innerHTML = "";
                snap.forEach(d => {
                    if(d.data().uid === currentUser.uid) {
                        grid.innerHTML += `<div class="grid-item"><video src="${d.data().videoUrl}#t=1" muted></video></div>`;
                    }
                });
            } catch(e) { grid.innerHTML = "No Data"; }
        };

        window.saveProfile = async () => {
            const n = document.getElementById('ed-name').value;
            const p = document.getElementById('ed-pic').value;
            await updateProfile(currentUser, { displayName: n, photoURL: p });
            closeModal('edit-modal');
            goMyProfile();
        };

        window.goPage = (p) => {
            document.querySelectorAll('.page').forEach(e=>e.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active'));
            if(p.includes('feed')) document.querySelectorAll('.nav-item')[0].classList.add('active');
            if(p.includes('profile')) document.querySelectorAll('.nav-item')[4].classList.add('active');
        };

        window.openModal = (id) => document.getElementById(id).style.display = 'flex';
        window.closeModal = (id) => document.getElementById(id).style.display = 'none';
        window.openEditProfile = () => openModal('edit-modal');
        window.toggleSettings = () => { const m=document.getElementById('settings-menu'); m.style.display=m.style.display==='block'?'none':'block'; };

        // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏•‡∏¢ ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏≠ Auth ‡πÄ‡∏™‡∏£‡πá‡∏à
        loadFeed();

    </script>
</body>
</html>